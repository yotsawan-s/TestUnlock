name: Test Excel Unlocker

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ“‹ Create test Excel file with Sheet Protection
      run: |
        python << EOF
        from openpyxl import Workbook
        from openpyxl.styles import Font, PatternFill
        
        # à¸ªà¸£à¹‰à¸²à¸‡ workbook
        wb = Workbook()
        ws = wb.active
        ws.title = "à¸—à¸”à¸ªà¸­à¸š"
        
        # à¹€à¸à¸´à¹ˆà¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸”à¸ªà¸­à¸š
        ws['A1'] = 'à¸Šà¸·à¹ˆà¸­'
        ws['B1'] = 'à¸™à¸²à¸¡à¸ªà¸à¸¸à¸¥'
        ws['C1'] = 'à¸­à¸µà¹€à¸¡à¸¥'
        
        # à¸•à¸à¹à¸•à¹ˆà¸‡ header
        for cell in ws[1]:
            cell.font = Font(bold=True)
            cell.fill = PatternFill(start_color="CCCCCC", end_color="CCCCCC", fill_type="solid")
        
        # à¹€à¸à¸´à¹ˆà¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
        ws['A2'] = 'à¸ªà¸¡à¸Šà¸²à¸¢'
        ws['B2'] = 'à¹ƒà¸ˆà¸”à¸µ'
        ws['C2'] = 'somchai@example.com'
        
        ws['A3'] = 'à¸ªà¸¡à¸«à¸à¸´à¸‡'
        ws['B3'] = 'à¸£à¸±à¸à¸ªà¸¸à¸‚'
        ws['C3'] = 'somying@example.com'
        
        # à¸¥à¹‡à¸­à¸„ sheet (Sheet Protection)
        ws.protection.sheet = True
        ws.protection.password = 'test123'
        
        # à¹€à¸à¸´à¹ˆà¸¡ sheet à¸—à¸µà¹ˆà¸ªà¸­à¸‡
        ws2 = wb.create_sheet("à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡")
        ws2['A1'] = 'à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸”à¸ªà¸­à¸š'
        ws2.protection.sheet = True
        ws2.protection.password = 'test456'
        
        # à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸Ÿà¸¥à¹Œ
        wb.save('test_samples/locked_test.xlsx')
        print("âœ… à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œà¸—à¸”à¸ªà¸­à¸šà¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢: test_samples/locked_test.xlsx")
        EOF
    
    - name: ğŸ” Check locked file
      run: |
        echo "ğŸ“ à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¸ªà¸£à¹‰à¸²à¸‡:"
        ls -lh test_samples/
        
    - name: ğŸ”“ Test unlocking Sheet Protection
      run: |
        python << EOF
        from openpyxl import load_workbook
        
        print("=" * 60)
        print("ğŸ§ª à¹€à¸£à¸´à¹ˆà¸¡à¸—à¸”à¸ªà¸­à¸šà¸à¸²à¸£à¸›à¸¥à¸”à¸¥à¹‡à¸­à¸„ Sheet Protection")
        print("=" * 60)
        
        input_file = 'test_samples/locked_test.xlsx'
        output_file = 'test_samples/unlocked_test.xlsx'
        
        # à¹‚à¸«à¸¥à¸”à¹„à¸Ÿà¸¥à¹Œ
        wb = load_workbook(input_file)
        
        print(f"\nğŸ“Š à¸ˆà¸³à¸™à¸§à¸™ sheets: {len(wb.worksheets)}")
        
        # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š sheets à¸—à¸µà¹ˆà¸¥à¹‡à¸­à¸„
        locked_count = 0
        for sheet in wb.worksheets:
            if sheet.protection.sheet:
                locked_count += 1
                print(f"ğŸ”’ Sheet '{sheet.title}' à¸–à¸¹à¸à¸¥à¹‡à¸­à¸„à¸­à¸¢à¸¹à¹ˆ")
        
        print(f"\nğŸ”¢ à¸à¸š {locked_count} sheets à¸—à¸µà¹ˆà¸–à¸¹à¸à¸¥à¹‡à¸­à¸„")
        
        # à¸›à¸¥à¸”à¸¥à¹‡à¸­à¸„à¸—à¸¸à¸ sheet
        print("\nğŸ”“ à¸à¸³à¸¥à¸±à¸‡à¸›à¸¥à¸”à¸¥à¹‡à¸­à¸„...")
        for sheet in wb.worksheets:
            sheet.protection.sheet = False
            print(f"   âœ… à¸›à¸¥à¸”à¸¥à¹‡à¸­à¸„ sheet: {sheet.title}")
        
        # à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸Ÿà¸¥à¹Œ
        wb.save(output_file)
        
        print(f"\nğŸ’¾ à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¸›à¸¥à¸”à¸¥à¹‡à¸­à¸„à¹à¸¥à¹‰à¸§: {output_file}")
        
        # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸›à¸¥à¸”à¸¥à¹‡à¸­à¸„à¸ªà¸³à¹€à¸£à¹‡à¸ˆ
        wb2 = load_workbook(output_file)
        unlocked_count = 0
        for sheet in wb2.worksheets:
            if not sheet.protection.sheet:
                unlocked_count += 1
        
        print(f"\nâœ… à¸œà¸¥à¸à¸²à¸£à¸—à¸”à¸ªà¸­à¸š: à¸›à¸¥à¸”à¸¥à¹‡à¸­à¸„à¸ªà¸³à¹€à¸£à¹‡à¸ˆ {unlocked_count}/{len(wb2.worksheets)} sheets")
        
        if unlocked_count == len(wb2.worksheets):
            print("ğŸ‰ à¸à¸²à¸£à¸—à¸”à¸ªà¸­à¸šà¸œà¹ˆà¸²à¸™! à¸—à¸¸à¸ sheets à¸–à¸¹à¸à¸›à¸¥à¸”à¸¥à¹‡à¸­à¸„à¹à¸¥à¹‰à¸§")
        else:
            print("âŒ à¸à¸²à¸£à¸—à¸”à¸ªà¸­à¸šà¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§!")
            exit(1)
        
        print("=" * 60)
        EOF
    
    - name: ğŸ“¤ Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-excel-files
        path: test_samples/
        retention-days: 7
    
    - name: âœ… Test Summary
      run: |
        echo "## ğŸ‰ à¸à¸²à¸£à¸—à¸”à¸ªà¸­à¸šà¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### à¸œà¸¥à¸à¸²à¸£à¸—à¸”à¸ªà¸­à¸š:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œ Excel à¸—à¸”à¸ªà¸­à¸šà¸ªà¸³à¹€à¸£à¹‡à¸ˆ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… à¸›à¸¥à¸”à¸¥à¹‡à¸­à¸„ Sheet Protection à¸ªà¸³à¹€à¸£à¹‡à¸ˆ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¸ªà¸³à¹€à¸£à¹‡à¸ˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¥ à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¹„à¸Ÿà¸¥à¹Œà¸—à¸”à¸ªà¸­à¸š:" >> $GITHUB_STEP_SUMMARY
        echo "à¹„à¸Ÿà¸¥à¹Œà¸—à¸”à¸ªà¸­à¸šà¸–à¸¹à¸à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸›à¹‡à¸™ artifacts à¹à¸¥à¹‰à¸§ à¸ªà¸²à¸¡à¸²à¸£à¸–à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¹„à¸”à¹‰à¸ˆà¸²à¸à¸«à¸™à¹‰à¸² Actions" >> $GITHUB_STEP_SUMMARY
